
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Interrupts and timers &#8212; ELE102</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script src="../../_static/documentation_options.js?v=ae12eeca"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'texts/Lessons/L7_timer_interrupt';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="LC-Display" href="L8_LC_display.html" />
    <link rel="prev" title="Serial I/O" href="L6_serial_io.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/hvl_logo_engelsk.png" class="logo__image only-light" alt="ELE102 - Home"/>
    <script>document.write(`<img src="../../_static/hvl_logo_engelsk.png" class="logo__image only-dark" alt="ELE102 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Lessons:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="L0_Introduction_elk.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="software_hardware_preparations.html">Software and hardware preparations</a></li>
<li class="toctree-l1"><a class="reference internal" href="L1a_UC_intro.html">Lesson 1a: What is a Microcontroller</a></li>
<li class="toctree-l1"><a class="reference internal" href="L1b_Arduino_intro.html">Lesson 1b: Introduction to Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2_digital_io.html">Lesson 2: Digital I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="L3_digital_io_and_timing.html">Lesson 3: Use of digital I/O and timing</a></li>
<li class="toctree-l1"><a class="reference internal" href="L4_dac_pwm.html">Lesson 4: Analog output (PWM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="L5_adc.html">Lesson 5: Analog to digital conversion (ADC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="L6_serial_io.html">Lesson 6: Serial I/O</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lesson 7: Timers and interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="L8_LC_display.html">Lesson 8: LC-Display</a></li>
<li class="toctree-l1"><a class="reference internal" href="L9_memory_and_architecture.html">Lesson 9: Memory and MCU architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="L10_motor_drive.html">Lesson 10: Motor drive</a></li>
<li class="toctree-l1"><a class="reference internal" href="L12_communication.html">Lesson 11: Communication Protocols</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional material:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L1_additional.html">Additional material lesson 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L2_additional.html">Additional material lesson 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L3_additional.html">Additional material lesson 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L4_additional.html">Additional material lesson 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L5_additional.html">Additional material lesson 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L6_additional.html">Additional material lesson 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L7_additional.html">Additional material lesson 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L8_additional.html">Additional material lesson 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L9_additional.html">Additional material lesson 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L10_additional.html">Additional material lesson 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L11_additional.html">Additional material lesson 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L12_additional.html">Additional material lesson 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Lessons-additional/L13_additional.html">Additional material lesson 13</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Appendices/Additionals.html">Binary counter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/ir_communication.html">Infrared remote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/adaptive_line_enhancer.html">Adaptive line enhancer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/audio_processing.html">Audio processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/RC_car.html">Cool Project: RC Car (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/Robotarm.html">Cool Project: Simple Robot Arm (Bluetooth or Joystick)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/dc_motor_control.html">DC motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/digital_piano.html">Digital piano</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/digital_synth.html">Digital synth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/dtmf_generator.html">DTMF generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/frequency_estimator.html">Frequency estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/induction_motor_control.html">Induction motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/lorawan.html">LoRaWan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phase_displacement.html">Phase displacement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phase_locked_loop.html">Phase locked loop (PLL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/phasor_estimation.html">Phasor estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/radio_transmitter.html">Radio transmitter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/stepper_motor_control.html">Stepper motor control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/synchroscope.html">Synchroscope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Projects/thyristor_controller.html">Thyristor controller</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Appendices/low_power_operation.html">Low power operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/stacks_queues_lists.html">Stacks, Queues, Lists</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/assembly_programming.html">Assembly programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/digital_filters.html">Digital filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/floating_point_numbers.html">Floating point numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/kalman_filter.html">Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/the_build_process.html">The build process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Appendices/direct_register_manipulations.html">Direct register manipulation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/texts/Lessons/L7_timer_interrupt.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Interrupts and timers</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interrupts">Interrupts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interrupts-in-arduino">Interrupts in Arduino</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#external-interrupts">External Interrupts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-change-the-trigger-criteria">Exercise: change the trigger criteria</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-external-interrupt-on-rising-edge-of-both-pins">Demo: external interrupt on rising edge of both pins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-using-external-interrupts-to-count-switch-bouncing">Exercise: Using external interrupts to count switch bouncing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pin-change-interrupts">Pin change Interrupts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-interrupts">Internal Interrupts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#timers">Timers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timers-in-arduino">Timers in Arduino</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#different-timer-purposes">Different Timer purposes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timer-interrupts">Timer interrupts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-library-to-control-timer-1">Using a library to control timer 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-user-timer-isr-for-polling-digital-inputs">Exercise: User timer ISR for polling digital inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-rgb-led-blinking">Exercise: RGB led blinking</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-functions">Recursive functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random">Random</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="interrupts-and-timers">
<span id="l7-timer-interrupt"></span><h1>Interrupts and timers<a class="headerlink" href="#interrupts-and-timers" title="Link to this heading">#</a></h1>
<p>This lesson covers the two important and often related concepts of interrupts and timers in microcontrollers.</p>
<section id="interrupts">
<h2>Interrupts<a class="headerlink" href="#interrupts" title="Link to this heading">#</a></h2>
<p>A interrupt is some form of external signal that interrupts the main process. When an interrupt occurs the current execution state of the main process is stored, before a different process (the ISR, or interrupt service routine) takes over. When the interrupt service routine has completed, execution control is returned to the main process.</p>
<p>Interrupts are useful for making the system responsive to external events while avoiding constant polling of the possible external event sources. Sometimes the ISR may simply set a flag, or publish a message in a event queue such that the main process can take appropriate action when it is ready to do so.</p>
<a class="reference internal image-reference" href="../../_images/check-phone.gif"><img alt="../../_images/check-phone.gif" src="../../_images/check-phone.gif" style="width: 49%;" /></a>
<a class="reference internal image-reference" href="../../_images/phone-rings.gif"><img alt="../../_images/phone-rings.gif" src="../../_images/phone-rings.gif" style="width: 45%;" /></a>
<p>——————————–POLLING———————————–VS———————————-INTERRUPT—————————-</p>
<p>An interrupt is a signal that tells the processor to immediately stop what it is doing and handle some high priority processing.  That high priority processing is called an Interrupt Handler. An interrupt handler is like any other void function.  If you write one and attach it to an interrupt, it will get called whenever that interrupt signal is triggered.  When you return from the interrupt handler, the processor goes back to continue what it was doing before. <a class="footnote-reference brackets" href="#f4" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>Interrupts can be generated from several sources:</p>
<ol class="arabic simple">
<li><p>Timer interrupts from one of the Arduino timers.</p></li>
<li><p>External Interrupts from a change in state of one of the external interrupt pins.</p></li>
<li><p>Pin-change interrupts from a change in state of any one of a group of pins.</p></li>
</ol>
<p>Using interrupts, you don’t need to write loop code to continuously check for the high priority interrupt condition.  You don’t have to worry about sluggish response or missed button presses due to long-running subroutines.</p>
<p>The processor will automagically stop whatever it is doing when the interrupt occurs and call your interrupt handler.  You just need to write code to respond to the interrupt whenever it happens. <a class="footnote-reference brackets" href="#f4" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>Types of Interrupts
There are two types of interrupts:</p>
<p><strong>Hardware Interrupt:</strong> It happens when an external event occurs like an external interrupt pin changes its state from LOW to HIGH or HIGH to LOW.</p>
<p><strong>Software Interrupt:</strong> It happens according to the instruction from the software. For example Timer interrupts are software interrupt.</p>
<div class="admonition-start-with-an-exercise-class-myownstyle admonition">
<p class="admonition-title"><strong>Start with an exercise</strong>
 :class: myownstyle</p>
<blockquote>
<div><p>Use 3 LEDs attached to pin numbers 9,10,11. Turn them on one by one. When all are turned on, turn them of one by one in reverse order as shown in the GIF below. Wait 1 second every time you reverse the order.</p>
</div></blockquote>
<figure class="align-default">
<img alt="../../_images/led-on-off-in-order.gif" src="../../_images/led-on-off-in-order.gif" />
</figure>
<p>Now attach a button to the pin number 2 and update your code such that a counter will count everytime you press the button. Observe any problems?</p>
</div>
<section id="interrupts-in-arduino">
<h3>Interrupts in Arduino<a class="headerlink" href="#interrupts-in-arduino" title="Link to this heading">#</a></h3>
<p>There are some important keynotes <a class="reference external" href="https://www.arduino.cc/reference/en/language/functions/external-interrupts/attachinterrupt/">About Interrupt Service Routines</a>.</p>
<p>Properties of ISR (Interrupt Service Routine):</p>
<ol class="arabic simple">
<li><p>Global variables used in an ISR must be declared <code class="code docutils literal notranslate"><span class="pre">volatile</span></code>.</p></li>
<li><p>ISR should normally be fast and short functions.</p></li>
<li><p>No delay in the ISR.</p></li>
<li><p>Interrupts are disabled while the ISR is executed. They can be enabled, but this should normally be avoided as it might have unpredictable consequences.</p></li>
<li><p>An ISR cannot have parameters - no input argument, no output return.</p></li>
<li><p>Stops <strong>everything</strong> in the main function.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">millis()</span></code> doesn’t work properly, <code class="code docutils literal notranslate"><span class="pre">delayMicroseconds()</span></code> works since it does not rely on interrupts.</p></li>
</ol>
<p>Interrupts can be:</p>
<ul class="simple">
<li><p>Internal: Timers, ADC conversion complete, hardware faults, etc.</p></li>
<li><p>External: digital pins, or communication channels (UART/SPI/I2C)</p></li>
</ul>
<p>Interrupts can be enabled or disabled globally, i.e all interrupt sources can be enabled or disabled. This can be useful if it is important that some part of your code is able to run without interruption. There could be a multitude of reasons why your code should run without interruption. One possible reason is if the code is very timing critical, once it is started it has to execute as fast as possible. Another possibility could be that your code is manipulating some part of memory which some ISR is also manipulating. If your code is only half way through the manipulation when the ISR starts doing some other operation to the same memory (e.g. the same variable), the result will be unpredictable. This is known as a race condition.</p>
<ul class="simple">
<li><p>Enable interrupts by calling the function: <code class="code highlight ccode c docutils literal highlight-c"><span class="n">interrupts</span><span class="p">()</span></code>, or: <code class="code highlight ccode c docutils literal highlight-c"><span class="n">sei</span><span class="p">()</span></code></p></li>
<li><p>Disable interrupts by calling the function: <code class="code highlight ccode c docutils literal highlight-c"><span class="n">noInterrupts</span><span class="p">()</span></code>, or: <code class="code highlight ccode c docutils literal highlight-c"><span class="n">cli</span><span class="p">()</span></code></p></li>
</ul>
<p>Note that interrupts are enabled by default when your program starts.</p>
</section>
<section id="external-interrupts">
<h3>External Interrupts<a class="headerlink" href="#external-interrupts" title="Link to this heading">#</a></h3>
<p>There are multiple options for how an external interrupt is triggered. This can be configured by the Arduino library, but since it is really a hardware feature of the microcontroller the supported features may vary from one Arduino type to the next. Generally there are five conditions for triggering interrupts in the Arduino library, but only the first four are supported by the Atmega328p of the Arduino UNO:</p>
<ol class="arabic simple">
<li><p>Change: When signal change (sensitive to both rising and falling edge).</p></li>
<li><p>Rising: On a rising edge (the signal going from low to high, or from 0v to 5v).</p></li>
<li><p>Falling: On a falling edge (the signal going from high to low, or from 5v to 0v).</p></li>
<li><p>Low: Low is a continuous trigger whenever the signal is low, or 0v. I.e. if the voltage is low, the ISR will fire again as soon as it completes.</p></li>
<li><p>High: High is a continuous trigger whenever the signal is high, or 5v. (Not supported in Arduino UNO)</p></li>
</ol>
<p>An external interrupt is configured by the function call:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">some_pin_number</span><span class="p">),</span><span class="w"> </span><span class="n">ISR_function_callback</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span>
</pre></div>
</div>
<p>The first parameter to the <code class="code highlight ccode c docutils literal highlight-c"><span class="n">attachInterrupt</span><span class="p">()</span></code> function is the interrupt number. In order to have a more flexible and readable code, you should use the function <code class="code highlight ccode c docutils literal highlight-c"><span class="n">digitalPinToInterrupt</span><span class="p">()</span></code> to translate the pin number to the interrupt number. The second parameter, which is named <code class="code highlight ccode c docutils literal highlight-c"><span class="n">ISR_function_callback</span></code> in the above example, is the name of a function that you have defined. Any valid function name can be provided, and it should not include the parentheses that you normally use when calling a function. This function will be called whenever the interrupt is triggered. Finally the <code class="code highlight ccode c docutils literal highlight-c"><span class="n">mode</span></code> parameter is used to select which events on the external pin will cause the interrupt to trigger. As described previously, the following modes are available: <code class="code highlight ccode c docutils literal highlight-c"><span class="n">CHANGE</span></code>, <code class="code highlight ccode c docutils literal highlight-c"><span class="n">RISING</span></code>, <code class="code highlight ccode c docutils literal highlight-c"><span class="n">FALLING</span></code>, <code class="code highlight ccode c docutils literal highlight-c"><span class="n">LOW</span></code>, <code class="code highlight ccode c docutils literal highlight-c"><span class="n">HIGH</span></code>.</p>
<p>In order to disable the interrupt the following function call is used:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">detachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">some_pin_number</span><span class="p">))</span>
</pre></div>
</div>
<div class="myownstyle admonition">
<p class="admonition-title"><strong>Continue the exercise</strong></p>
<p>Now solve the count problem with interrupts.</p>
</div>
</section>
<section id="exercise-change-the-trigger-criteria">
<h3>Exercise: change the trigger criteria<a class="headerlink" href="#exercise-change-the-trigger-criteria" title="Link to this heading">#</a></h3>
<p>In this exercise you will change the criteria for how the external interrupt is triggered, and experience the effect it has on the behaviour of you program. You should use pull-up resistors, and allow the bush button to pull down the logic level of the input pin. This will allow you to more easily test the continuous trigger on logic low.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interrupt_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">external_interrupt_routine</span><span class="p">(){</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="n">interrupt_counter</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">  </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">12</span><span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">  </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">),</span><span class="w"> </span><span class="n">external_interrupt_routine</span><span class="p">,</span><span class="w"> </span><span class="n">CHANGE</span><span class="p">);</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="linenos">21</span><span class="p">}</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">isr_flag</span><span class="p">){</span>
<span class="linenos">26</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Counter: &quot;</span><span class="p">);</span>
<span class="linenos">27</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">interrupt_counter</span><span class="p">);</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="w">    </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">31</span><span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Upload and test the provided code.</p></li>
<li><p>Try all the different trigger modes which are supported. Take note on the behaviour of the counter in each case.</p></li>
<li><p>Extend the program with the ability to toggle the state of a LED on the rising edge interrupt.</p></li>
</ol>
<ol class="arabic simple">
<li><p>Write a program to blink a normal, or RBG-LED using <code class="code highlight ccode c docutils literal highlight-c"><span class="n">millis</span><span class="p">()</span></code> for the delay.</p></li>
<li><p>Modify the code such that the blinking should stop immediately as soon as a button is pressed, and should continue again as soon as it is released. Use an external interrupt to detect the rising and falling edge of the push button.</p></li>
</ol>
</section>
<section id="demo-external-interrupt-on-rising-edge-of-both-pins">
<h3>Demo: external interrupt on rising edge of both pins<a class="headerlink" href="#demo-external-interrupt-on-rising-edge-of-both-pins" title="Link to this heading">#</a></h3>
<p>The following example illustrates how to enable the ISR on both of the external interrupt pins. The ISR toggles an external LED, as well as increasing the value of a variable in order to keep track of how many times the ISR has been executed. Due to mechanical switch bouncing, the ISR can sometimes fire multiple times on each push of the button.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">interrupt1_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">interrupt2_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt1_routine</span><span class="p">(){</span>
<span class="linenos">13</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">));</span>
<span class="linenos">14</span><span class="w">  </span><span class="n">interrupt1_counter</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">15</span><span class="p">}</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt2_routine</span><span class="p">(){</span>
<span class="linenos">18</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">));</span>
<span class="linenos">19</span><span class="w">  </span><span class="n">interrupt2_counter</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">20</span><span class="p">}</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">25</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">28</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="w">  </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">),</span><span class="w"> </span><span class="n">interrupt1_routine</span><span class="p">,</span><span class="w"> </span><span class="n">RISING</span><span class="p">);</span>
<span class="linenos">31</span><span class="w">  </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interrupt2_pin</span><span class="p">),</span><span class="w"> </span><span class="n">interrupt2_routine</span><span class="p">,</span><span class="w"> </span><span class="n">RISING</span><span class="p">);</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="linenos">34</span><span class="p">}</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">prev_timestamp_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">37</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status_print_interval_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">current_timestamp_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">current_timestamp_ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prev_timestamp_ms</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">status_print_interval_ms</span><span class="p">){</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Counter 1: &quot;</span><span class="p">);</span>
<span class="linenos">45</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">interrupt1_counter</span><span class="p">);</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Counter 2: &quot;</span><span class="p">);</span>
<span class="linenos">48</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">interrupt2_counter</span><span class="p">);</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="w">    </span><span class="n">prev_timestamp_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_timestamp_ms</span><span class="p">;</span>
<span class="linenos">51</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">52</span><span class="p">}</span>
</pre></div>
</div>
<p>Instead of continuously printing the counter value with a interval of 1 second, it is also possible to only print it after a ISR has been executed:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">interrupt1_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">interrupt2_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt1_routine</span><span class="p">(){</span>
<span class="linenos">15</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">));</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">interrupt1_counter</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="w">  </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">19</span><span class="p">}</span>
<span class="linenos">20</span>
<span class="linenos">21</span><span class="kt">void</span><span class="w"> </span><span class="nf">interrupt2_routine</span><span class="p">(){</span>
<span class="linenos">22</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">));</span>
<span class="linenos">23</span><span class="w">  </span><span class="n">interrupt2_counter</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">  </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">26</span><span class="p">}</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">31</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">34</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">  </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">),</span><span class="w"> </span><span class="n">interrupt1_routine</span><span class="p">,</span><span class="w"> </span><span class="n">RISING</span><span class="p">);</span>
<span class="linenos">37</span><span class="w">  </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interrupt2_pin</span><span class="p">),</span><span class="w"> </span><span class="n">interrupt2_routine</span><span class="p">,</span><span class="w"> </span><span class="n">RISING</span><span class="p">);</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="linenos">40</span><span class="p">}</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">isr_flag</span><span class="p">){</span>
<span class="linenos">45</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Counter 1: &quot;</span><span class="p">);</span>
<span class="linenos">46</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">interrupt1_counter</span><span class="p">);</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Counter 2: &quot;</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">interrupt2_counter</span><span class="p">);</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="n">isr_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">54</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="exercise-using-external-interrupts-to-count-switch-bouncing">
<h3>Exercise: Using external interrupts to count switch bouncing<a class="headerlink" href="#exercise-using-external-interrupts-to-count-switch-bouncing" title="Link to this heading">#</a></h3>
<p>In order to determine how much your switch is actually bouncing, it is possible to use an external interrupt pin. The previous example illustrates this to some extent, but in this exercise you will develop a program which can be used to test the quality of your push buttons.</p>
<ol class="arabic simple">
<li><p>Connect a push button to one of the external interrupt pins (pin 2, or 3 on the Arduino UNO).</p></li>
<li><p>Configure the ISR to trigger on both rising and falling edge of the signal on the pin. Test by toggling a LED inside the ISR.</p></li>
<li><p>Increment two variables inside the ISR, one for rising, and one for falling edge. Add code inside your <code class="code docutils literal notranslate"><span class="pre">loop()</span></code> to print the value of the variables to the UART whenever they have changed. Do not use <code class="code docutils literal notranslate"><span class="pre">Serial.print</span></code> inside the ISR.</p></li>
<li><p>Add some code to keep track of the maximum number of times the switch has bounced. I.e. compare the current number of bounces to the previous maximum, and update if required. For this to work you must somehow determine when to stop counting. I.e. if you press the button twice (even if you do it quickly) it should count as two pushes, not as bouncing.</p></li>
<li><p>Add some code to keep track of the timing between each time the ISR is executed. Print the time interval ot the UART.</p></li>
</ol>
</section>
<section id="pin-change-interrupts">
<h3>Pin change Interrupts<a class="headerlink" href="#pin-change-interrupts" title="Link to this heading">#</a></h3>
<p>The external interrupts are only available on pin 2, and 3 on the Arduino UNO (this is a limitation of the microcontroller). The Atmega328p also support a feature known as pin change interrupt on all digital inputs. The pin change interrupt will cause an interrupt if any of the enabled pins in a group is changed. I.e. the same ISR will run regardless of which pin in the group has changed. This is not as flexible as the <em>external interrupt</em>, but it can still be useful. In many cases the first job of the pin change ISR will be to check (E.g. <code class="code highlight ccode c docutils literal highlight-c"><span class="n">digitalRead</span></code>) which pin generated the interrupt request.</p>
<p>The following example illustrates how to use the pin change interrupts on pin 8, 9 and 10. Since the feature is not supported by the Arduino library we have to access some hardware registers directly. Refer to the datasheet of the Atmega328p for understanding the purposes of each of the bits in the configuration registers.</p>
<p>A special function is defined for configuration of the pin change interrupt system. Without going in to the details, this function can be copied, and used to configure pin 8, 9, and 10 for pin change interrupt.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">configure_pin_change_interrupt</span><span class="p">(){</span>

<span class="w">  </span><span class="n">PCICR</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCIE2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCIE1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCIE0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Enable pin change interrupt on PCINT0 to PCINT7</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Pin 8 -&gt; PB0 -&gt; PCINT0</span>
<span class="cm">   * Pin 9 -&gt; PB1 -&gt; PCINT1</span>
<span class="cm">   * Pin 10 -&gt; PB2 -&gt; PCINT2</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="c1">//PCMSK2;</span>
<span class="w">  </span><span class="c1">//PCMSK1;</span>
<span class="w">  </span><span class="n">PCMSK0</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCINT2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCINT1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCINT0</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Further down in the code the function <code class="code highlight ccode c docutils literal highlight-c"><span class="n">ISR</span><span class="w"> </span><span class="p">(</span><span class="n">PCINT0_vect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span></code> is the definition of the ISR which execute when the pin change interrupt is triggered.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span>
<span class="linenos"> 5</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">interrupt3_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led1_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led2_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">void</span><span class="w"> </span><span class="nf">configure_pin_change_interrupt</span><span class="p">(){</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">  </span><span class="n">PCICR</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCIE2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCIE1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCIE0</span><span class="p">);</span><span class="w"> </span><span class="c1">// Enable pin change interrupt on PCINT0 to PCINT7</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="w">  </span><span class="cm">/**</span>
<span class="linenos">15</span><span class="cm">   * Pin 8 -&gt; PB0 -&gt; PCINT0</span>
<span class="linenos">16</span><span class="cm">   * Pin 9 -&gt; PB1 -&gt; PCINT1</span>
<span class="linenos">17</span><span class="cm">   * Pin 10 -&gt; PB2 -&gt; PCINT2</span>
<span class="linenos">18</span><span class="cm">   */</span>
<span class="linenos">19</span><span class="w">  </span><span class="c1">//PCMSK2;</span>
<span class="linenos">20</span><span class="w">  </span><span class="c1">//PCMSK1;</span>
<span class="linenos">21</span><span class="w">  </span><span class="n">PCMSK0</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCINT2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCINT1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PCINT0</span><span class="p">);</span>
<span class="linenos">22</span><span class="p">}</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">27</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">28</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interrupt3_pin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">);</span>
<span class="linenos">29</span><span class="w">  </span>
<span class="linenos">30</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">31</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">32</span>
<span class="linenos">33</span><span class="w">  </span><span class="n">configure_pin_change_interrupt</span><span class="p">();</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="linenos">36</span><span class="p">}</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">39</span><span class="w">  </span><span class="c1">// Do nothing here...</span>
<span class="linenos">40</span><span class="p">}</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="n">ISR</span><span class="w"> </span><span class="p">(</span><span class="n">PCINT0_vect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">port_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PINB</span><span class="p">;</span><span class="w"> </span><span class="c1">// Read the status of the input port B</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">port_state</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x07</span><span class="p">)</span><span class="w"> </span><span class="c1">// Only concider the lower 3 bits</span>
<span class="linenos">47</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">48</span><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="c1">// We are using pull up resistors, hence the state will be 0b110, or 6 when pin 8 is low</span>
<span class="linenos">49</span><span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led1_pin</span><span class="p">));</span>
<span class="linenos">50</span><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">51</span><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="c1">// 0b101</span>
<span class="linenos">52</span><span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led2_pin</span><span class="p">));</span>
<span class="linenos">53</span><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">54</span><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="c1">// 0b011</span>
<span class="linenos">55</span><span class="w">    </span>
<span class="linenos">56</span><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">57</span><span class="w">  </span><span class="k">default</span><span class="o">:</span>
<span class="linenos">58</span><span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">59</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">60</span><span class="p">}</span>
<span class="linenos">61</span>
<span class="linenos">62</span><span class="n">ISR</span><span class="w"> </span><span class="p">(</span><span class="n">PCINT1_vect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">63</span><span class="p">}</span>
<span class="linenos">64</span>
<span class="linenos">65</span><span class="n">ISR</span><span class="w"> </span><span class="p">(</span><span class="n">PCINT2_vect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">66</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="internal-interrupts">
<h3>Internal Interrupts<a class="headerlink" href="#internal-interrupts" title="Link to this heading">#</a></h3>
<p>Internal interrupt are interrupt which are initiated by some internal hardware of the microcontroller. One example is the timer based interrupts, which are issued on some event from one of the hardware timers. E.g. when a certain time limit has expired. This particular interrupt type will be covered in the section about timers.</p>
</section>
</section>
<section id="timers">
<h2>Timers<a class="headerlink" href="#timers" title="Link to this heading">#</a></h2>
<p>A timer in this context is a specialized type of hardware peripheral which is used to measure time intervals. On the fundamental level the hardware timers are built around counters, which count on the edges of some external clock signal. A timer that counts from zero upwards and stops on some external event, for measuring time elapsed until the event is often called a stopwatch. On the other hand, a device that counts down from a specified initial time, and generates an event when it reaches zero is a timer.</p>
<p>A counter is a device that stores (and sometimes displays) the number of times a particular event or process occurred, with respect to a clock signal. It is used to count the events happening outside the microcontroller. In electronics, counters can be implemented quite easily using register-type circuits such as a flip-flop. <a class="footnote-reference brackets" href="#f2" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p>
<p>Timers are counters that can be programmed to perform a variety of functions. Following are the typical operation modes and possible applications of timers:</p>
<p><strong>1. Programmed operation:</strong> A timer can be used as an alarm clock to generate predetermined time delays. The  microprocessor sets the count limit or initializes the counter and enables the count operation. The timer generates an interrupt when the count limit is reached indicating the end of the programmed delay period. This mode of operation utilizes the internal clock and it does not require an external connection.</p>
<p><strong>2. Gated or triggered operation:</strong> The count operation is controlled by an external signal. There may be several options to start and to stop the counter. In gated mode, the counter is enabled while the external signal is active. A multi-purpose timer allows independent selection of events that start and stop the counter. These events can be a rising or falling edge of the external trigger signal or an internal start/stop command issued by the microprocessor itself. The timer can be programmed to generate an interrupt when the counter stops. The common applications of gated or triggered operation involve any kind of time measurements, such as, measuring revolution time of a motor to detect its rotation speed, or quantification of time-encoded signals.</p>
<p><strong>3. Clocked operation:</strong> The counter clock is supplied by an external signal while the count operation is enabled by the microprocessor or another timer. The typical applications include quantization of frequency-encoded signals, or position information generated by linear or rotational encoders.</p>
<p>The specifications for a timer are directly related to the requirements of the application:</p>
<p><strong>1. Maximum clock frequency</strong> determines the timing resolution. The internal clock frequencies available for timer operations depend on the microprocessor clock.</p>
<p><strong>2. Number of counter bits</strong> determines the count range or the maximum time period that can be measured.</p>
<p><strong>3. Functionality:</strong> Having a programmable timer does not necessarily mean that it will support all operation modes and gating or triggering options. You need to read the timer description to find out whether it is useful for your application or not. You may as well need additional features such as buffering of timer count results for motor speed measurements. A timer with buffered outputs can store the count result at the end of every motor revolution and re-start the counting process immediately.</p>
<p><strong>Watchdog timers</strong> are special-purpose timers dedicated to ensure the proper execution of microcontroller functions. The processor is required to restart the watchdog timer before the preset timer period expires and it repeats this operation as long as the watchdog function is enabled. The program written for the processor includes the necessary statements to restart the watchdog timer periodically. If the processor fails to restart the watchdog timer, then this indicates a major functional failure due to corrupt program memory or some other reason. In this case, the watchdog timer resets the processor, forcing initialization of all microcontroller functions <a class="footnote-reference brackets" href="#f1" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<section id="timers-in-arduino">
<h3>Timers in Arduino<a class="headerlink" href="#timers-in-arduino" title="Link to this heading">#</a></h3>
<p>Normally the timers are clocked by the system clock of your Atmega328p. The system clock is 16MHz, but a prescaler is available to divide this clock by some configurable constant in order to have a slower timing operation. The timer hardware is configured by means of some special timer registers. In the Arduino firmware all timers were configured to a 1kHz frequency and interrupts are generally enabled.</p>
<p><strong>Timer0:</strong>
Timer0 is a 8bit timer.
In the Arduino world timer0 is been used for the timer functions, like [delay() 811](<a class="reference external" href="http://arduino.cc/en/Reference/Delay">http://arduino.cc/en/Reference/Delay</a>),[ millis() 1.8k](<a class="reference external" href="http://arduino.cc/en/Reference/Millis">http://arduino.cc/en/Reference/Millis</a>) and[ micros() 804](<a class="reference external" href="http://arduino.cc/en/Reference/Micros">http://arduino.cc/en/Reference/Micros</a>). If you change timer0 registers, this may influence the Arduino timer function. So you should know what you are doing.</p>
<p><strong>Timer1:</strong>
Timer1 is a 16bit timer.
In the Arduino world the [Servo library 1.3k](<a class="reference external" href="http://arduino.cc/en/Reference/Servo">http://arduino.cc/en/Reference/Servo</a>) uses timer1 on Arduino Uno (timer5 on Arduino Mega).</p>
<p><strong>Timer2:</strong>
Timer2 is a 8bit timer like timer0.
In the Arduino work the [tone() 1.1k](<a class="reference external" href="http://arduino.cc/en/Reference/Tone">http://arduino.cc/en/Reference/Tone</a>) function uses timer2.</p>
<p>Timer3, Timer4, Timer5:
Timer 3,4,5 are only available on Arduino Mega boards. These timers are all 16bit timers. <a class="footnote-reference brackets" href="#f3" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://www.robotshop.com/community/forum/t/arduino-101-timers-and-interrupts/13072">Arduino timers for *super nerd*s</a>, if you would like to know all the low level details of the timers.</p>
</div>
</section>
<section id="different-timer-purposes">
<h3>Different Timer purposes<a class="headerlink" href="#different-timer-purposes" title="Link to this heading">#</a></h3>
<p>Timer Overflow:
Timer overflow means the timer has reached is limit value. When a timer overflow interrupt occurs, the timer overflow bit TOVx will be set in the interrupt flag register TIFRx. When the timer overflow interrupt enable bit TOIEx in the interrupt mask register TIMSKx is set, the timer overflow interrupt service routine ISR(TIMERx_OVF_vect)  will be called.</p>
<p>Output Compare Match:
When a output compare match interrupt occurs, the OCFxy flag will be set in the interrupt flag register TIFRx . When the output compare interrupt enable bit OCIExy in the interrupt mask register TIMSKx is set, the output compare match interrupt service ISR(TIMERx_COMPy_vect) routine will be called.</p>
<p>Timer Input Capture:
When a timer input capture interrupt occurs, the input capture flag bit ICFx will be set in the interrupt flag register TIFRx. When the input capture interrupt enable bit  ICIEx in the interrupt mask register TIMSKx is set, the timer input capture interrupt service routine ISR(TIMERx_CAPT_vect) will be called.</p>
<p>PWM and timer
There is fixed relation between the timers and the PWM capable outputs. When you look in the data sheet or the pinout of the processor these PWM capable pins have names like OCRxA, OCRxB or OCRxC (where x means the timer number 0..5). The PWM functionality is often shared with other pin functionality.
The Arduino has 3Timers and 6 PWM output pins. The relation between timers and PWM outputs is:
Pins 5 and 6: controlled by timer0
Pins 9 and 10: controlled by timer1
Pins 11 and 3: controlled by timer2</p>
<p>Servo Library uses Timer1. You can’t use PWM on Pin 9, 10 when you use the Servo Library on an Arduino</p>
</section>
<section id="timer-interrupts">
<h3>Timer interrupts<a class="headerlink" href="#timer-interrupts" title="Link to this heading">#</a></h3>
<p>On the Atmega328p the timer clock signal is normally derived from the system clock, but typically scaled down to a lower rate. The system clock is 16 MHz on the Arduino UNO, but for the Arduino Pro 3,3V it is 8Mhz. The timer hardware can be configured with some special timer registers. In the Arduino firmware all timers are configured to a 1kHz frequency and interrupts are generally enabled.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Modification of timer behaviour through register manipulation is rather advanced, and will not be covered here. This subject requires at least intermediate embedded programming skills and datasheet reading. However, this is an important topic to know for the embedded systems developer. For those who are willing to learn this topic the following application note could be useful: <a class="reference external" href="http://ww1.microchip.com/downloads/en/AppNotes/Atmel-2505-Setup-and-Use-of-AVR-Timers_ApplicationNote_AVR130.pdf">AVR130: Setup and Use the AVR Timers</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="code docutils literal notranslate"><span class="pre">interrupts()</span></code> and <code class="code docutils literal notranslate"><span class="pre">noInterrupts()</span></code> for the critical parts of the code. - <a class="reference external" href="https://www.arduino.cc/reference/en/language/functions/interrupts/interrupts/">https://www.arduino.cc/reference/en/language/functions/interrupts/interrupts/</a></p>
</div>
</section>
<section id="using-a-library-to-control-timer-1">
<h3>Using a library to control timer 1<a class="headerlink" href="#using-a-library-to-control-timer-1" title="Link to this heading">#</a></h3>
<p>Since direct register manipulation is cumbersome, and also typically specific to only one, or a limited number of specific hardware platforms, it is often preferable to use a library to configure the timers. In this section we will cover the <em>TimerOne</em> library, which allows us to configure timer 1.</p>
<p>The analog write function for pin 9, and 10 on the Arduino depends on timer 1. If you are using these libraries you will not be able to use those pins for PWM (at least it will not be reliable).</p>
<p>The following code listing shows how to blink a led at a rate of 1 Hz, using the TimerOne library:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;TimerOne.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led_pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">void</span><span class="w"> </span><span class="nf">led_toggle_function</span><span class="p">(){</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">led_pin</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">led_pin</span><span class="p">));</span>
<span class="linenos"> 8</span><span class="p">}</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">11</span><span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">led_pin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="linenos">12</span><span class="w">  </span>
<span class="linenos">13</span><span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">  </span><span class="n">Timer1</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="mi">500000</span><span class="p">);</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">Timer1</span><span class="p">.</span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">led_toggle_function</span><span class="p">);</span>
<span class="linenos">17</span><span class="p">}</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">20</span><span class="w">  </span><span class="c1">// No need to do anything here...</span>
<span class="linenos">21</span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="code highlight ccode c docutils literal highlight-c"><span class="n">Timer1</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="mi">500000</span><span class="p">);</span></code> method sets the timeout to <span class="math notranslate nohighlight">\(500000\)</span> microsecond, or <span class="math notranslate nohighlight">\(0.5\)</span> seconds. The maximum value for the time period is <span class="math notranslate nohighlight">\(8388480\)</span> microseconds, or about <span class="math notranslate nohighlight">\(8.3\)</span> seconds.</p>
<p>The timer can be started (<code class="code highlight ccode c docutils literal highlight-c"><span class="n">Timer1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span></code>), stopped (<code class="code highlight ccode c docutils literal highlight-c"><span class="n">Timer1</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span></code>), and restarted (<code class="code highlight ccode c docutils literal highlight-c"><span class="n">Timer1</span><span class="p">.</span><span class="n">restart</span><span class="p">()</span></code>) on demand by the application.</p>
</section>
<section id="exercise-user-timer-isr-for-polling-digital-inputs">
<h3>Exercise: User timer ISR for polling digital inputs<a class="headerlink" href="#exercise-user-timer-isr-for-polling-digital-inputs" title="Link to this heading">#</a></h3>
<p>This exercise is a little bit challenging, but demonstrate a very relevant problem and common use case for a timer.</p>
<ol class="arabic simple">
<li><p>Use the TimerOne library to generate an interrupt with a interval of 5 millisecond.</p></li>
<li><p>Use the timer ISR to poll the state of three push buttons.</p></li>
<li><p>Store the state of the push buttons, and compare them to the previous state. If the state remains stable for two invocations of the ISR, they should be considered valid (i.e. debounced).</p></li>
<li><p>Write a function <code class="code highlight ccode c docutils literal highlight-c"><span class="kt">uint8_t</span><span class="w"> </span><span class="n">get_btn_rising_edge_event</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">btn</span><span class="p">)</span></code> which returns true the first time it is called for a given button, after the button has had a rising edge. The function must reset a rising edge detected flag back to zero after invocation, in order to ensure that successive calls does not return true unless the flag has again been set by the ISR.</p></li>
<li><p>Write a function <code class="code highlight ccode c docutils literal highlight-c"><span class="kt">uint8_t</span><span class="w"> </span><span class="n">get_btn_falling_edge_event</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">btn</span><span class="p">)</span></code> which returns true the first time it is called for a given button, after the button has had a falling edge.</p></li>
<li><p>Add a routine to <code class="code highlight ccode c docutils literal highlight-c"><span class="n">loop</span><span class="p">()</span></code> which prints a message on rising, and falling edge of each push button.</p></li>
</ol>
</section>
<section id="exercise-rgb-led-blinking">
<h3>Exercise: RGB led blinking<a class="headerlink" href="#exercise-rgb-led-blinking" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Write a program which blinks a RGB lamp, blinking each LED for 1 second (reg, green, blue, white) and repeat it infinitely. The blink frequency should be 5 Hz. Do not use any interrupt or hardware timer knowledge at first and let’s see what can be done to solve the problem. (you may use <code class="code highlight ccode c docutils literal highlight-c"><span class="n">millis</span><span class="p">()</span></code>)</p></li>
<li><p>Attach a button that stops blinking of all LEDs.</p></li>
<li><p>Modify (or rewrite) your program to use the TimerOne library for the timing, and define your button as an external interrupt.</p></li>
<li><p>Write a short summary of the advantages and disadvantages for each of your two solutions.</p></li>
</ol>
</section>
</section>
<section id="recursive-functions">
<h2>Recursive functions<a class="headerlink" href="#recursive-functions" title="Link to this heading">#</a></h2>
<p>Since we know conditionals, functions, loops and arrays we can talk about common paradigm in programming languages: <strong>Recursive Functions</strong>. There are still discussions about whether recursive functions are bad or good, they are staple in procedural programming languages (like C, Fortran, Pascal) and also commonly used in object-oriented programming languages (like C++, C#, Python).</p>
<p>By definition a recursive function is one that calls back to itself. The most common example might be the Fibonacci.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">ledPin</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="n">fibonacci</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
  <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">fibonacci</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>The good</strong> about recursive functions are generally shorter and more elegant. <strong>The bad</strong> sides of the recursion is mainly that recursive functions are less efficient than their iterative counterparts. Additionally, they are subject to the perils of stack overflows, which is <em>probably the most common</em> error in early programming languages that happens when program tries to use more memory space than the call stack has available.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://stackoverflow.com/">https://stackoverflow.com</a> is the number one website for programmers!</p>
</div>
<p>From Arduino perspective, the situation is 50/50. Recursive functions are resource intensive and we don’t like using any resources (neither memory nor power) on microcontrollers. An embedded software project has to do a resource budget. However, recursive functions are easy to implement and comprehend. Particularly sensor applications where there is a data to be manipulated based on previous readings, recursive functions can be an option.</p>
<p>One last thing to note, it does not take too long to fill the 2KBytes memory of Arduino. If you need to recurse too much than you may need to free some memory. We will not get into details of it since it has too many branches when it comes to embedded systems programming. Particularly Run-time performance constraints and Memory constraints are acknowledged as the most effort requiring skills in all software applications. Since these are the most critical points in microcontrollers, embedded system software development is scientifically approved the <a class="reference external" href="https://en.wikipedia.org/wiki/COCOMO">most difficult of programming skills to master</a>.</p>
</section>
<section id="random">
<h2>Random<a class="headerlink" href="#random" title="Link to this heading">#</a></h2>
<p>What is random? Is there such a thing?</p>
<p>The arduino <code class="code docutils literal notranslate"><span class="pre">random()</span></code> function created <a class="reference external" href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator">Pseudorandom number</a>. However, it is not truely random. It creates random numbers based on an initial value. This initial value is the <code class="code docutils literal notranslate"><span class="pre">time(0)</span></code> where Arduino is first powered.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">randNumber</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// print a random number from 0 to 299</span>
<span class="w">  </span><span class="n">randNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">randNumber</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// print a random number from 10 to 19</span>
<span class="w">  </span><span class="n">randNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">randNumber</span><span class="p">);</span>

<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is quite a special subject in all programming languages. By providing different <em>seed</em> s. It is a bit of an issue in C# to create truely random but we are slightly luckier on the Arduino side.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// if analog input pin 0 is unconnected, random analog</span>
<span class="w">  </span><span class="c1">// noise will cause the call to randomSeed() to generate</span>
<span class="w">  </span><span class="c1">// different seed numbers each time the sketch runs.</span>
<span class="w">  </span><span class="c1">// randomSeed() will then shuffle the random function.</span>
<span class="w">  </span><span class="n">randomSeed</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">randomSeed(analogRead(0));</span></code> creates a random seed based on the noise signal on A0 pin.</p>
<p>Check this out:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">long</span><span class="w"> </span><span class="n">randNumber</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// randomSeed(5);</span>
<span class="w">  </span><span class="n">randomSeed</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// print a random number from 0 to 299</span>
<span class="w">  </span><span class="n">randNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">randNumber</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// print a random unsigned int</span>
<span class="w">  </span><span class="n">randNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">randNumber</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// print a random number from 10 to 19</span>
<span class="w">  </span><span class="n">randNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">randNumber</span><span class="p">);</span>

<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p><strong>Properties TL;DR:</strong></p>
<ul class="simple">
<li><p>Interrupt Service Routine function (ISR) must be as short as possible.</p></li>
<li><p>Delay () function doesn’t work inside ISR and should be avoided.</p></li>
<li><p>No input no output</p></li>
<li><p>No serial. (if you have to, then maybe Serial.print())</p></li>
<li><p>delayMicroseconds() works 1-2</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">myDelay</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">   </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;=</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>variables must be volatile</p></li>
<li><p>Sometimes need to disable interrupts:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">noInterrupts</span><span class="w"> </span><span class="p">();</span>
<span class="kt">long</span><span class="w"> </span><span class="n">myCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isrCounter</span><span class="p">;</span><span class="w">  </span><span class="c1">// get value set by ISR</span>
<span class="n">interrupts</span><span class="w"> </span><span class="p">();</span>
</pre></div>
</div>
<p>The most basic code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">ledPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">interruptPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="k">volatile</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOW</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interruptPin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span>
<span class="w">    </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interruptPin</span><span class="p">),</span><span class="w"> </span><span class="n">blink</span><span class="p">,</span><span class="w"> </span><span class="n">CHANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">blink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">state</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or modify:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">ledPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">interruptPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="k">volatile</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOW</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">interruptPin</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span>
<span class="w">    </span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">interruptPin</span><span class="p">),</span><span class="w"> </span><span class="n">blink</span><span class="p">,</span><span class="w"> </span><span class="n">CHANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">blink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">References</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>)</span>
<p><a class="reference external" href="https://learn.adafruit.com/multi-tasking-the-arduino-part-2/what-is-an-interrupt">https://learn.adafruit.com/multi-tasking-the-arduino-part-2/what-is-an-interrupt</a></p>
</aside>
<aside class="footnote brackets" id="f1" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">2</a><span class="fn-bracket">]</span></span>
<p>Izmir Institute of Technology - Department of Electrical and Electronics Engineering <em>EE443 - Embedded Systems lecture notes - 2013</em></p>
</aside>
<aside class="footnote brackets" id="f2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.tutorialspoint.com/embedded_systems/es_timer_counter.htm">https://www.tutorialspoint.com/embedded_systems/es_timer_counter.htm</a></p>
</aside>
<aside class="footnote brackets" id="f3" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.robotshop.com/community/forum/t/arduino-101-timers-and-interrupts/13072">https://www.robotshop.com/community/forum/t/arduino-101-timers-and-interrupts/13072</a></p>
</aside>
</aside>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="L6_serial_io.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Serial I/O</p>
      </div>
    </a>
    <a class="right-next"
       href="L8_LC_display.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">LC-Display</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interrupts">Interrupts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interrupts-in-arduino">Interrupts in Arduino</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#external-interrupts">External Interrupts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-change-the-trigger-criteria">Exercise: change the trigger criteria</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-external-interrupt-on-rising-edge-of-both-pins">Demo: external interrupt on rising edge of both pins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-using-external-interrupts-to-count-switch-bouncing">Exercise: Using external interrupts to count switch bouncing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pin-change-interrupts">Pin change Interrupts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-interrupts">Internal Interrupts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#timers">Timers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timers-in-arduino">Timers in Arduino</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#different-timer-purposes">Different Timer purposes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timer-interrupts">Timer interrupts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-library-to-control-timer-1">Using a library to control timer 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-user-timer-isr-for-polling-digital-inputs">Exercise: User timer ISR for polling digital inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-rgb-led-blinking">Exercise: RGB led blinking</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-functions">Recursive functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random">Random</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Gizem Ateş & Eirik Haustveit 
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022, Gizem Ateş &amp; Eirik Haustveit.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>